# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# GitHub Actions â€“ Apply (post-merge)
# Landing Zone Factory â€“ Canary/Wave deployment
#
# Mode-aware: lzctl auto-detects accelerator vs manual mode
# from the tenant manifest and uses terraform or terragrunt
# accordingly.
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

name: "ðŸš€ Apply Landing Zone"

on:
  push:
    branches: [main]
    paths:
      - "tenants/**"
      - "modules/**"
  workflow_dispatch:
    inputs:
      tenant:
        description: "Tenant name"
        required: true
      ring:
        description: "Deployment ring"
        required: true
        default: "canary"
        type: choice
        options: [canary, wave1, wave2, all]
      layer:
        description: "Specific layer (leave empty for all)"
        required: false
        default: ""

permissions:
  contents: write
  id-token: write

env:
  TF_VERSION: "1.9.0"
  TG_VERSION: "0.67.0"
  GO_VERSION: "1.24"
  LZCTL_REPO_ROOT: ${{ github.workspace }}

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Pre-flight
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  preflight:
    name: "ðŸ”Ž Pre-flight"
    runs-on: ubuntu-latest
    outputs:
      tenant: ${{ steps.resolve.outputs.tenant }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Build lzctl
        run: go build -o ${{ github.workspace }}/bin/lzctl . && echo "${{ github.workspace }}/bin" >> $GITHUB_PATH

      - name: Resolve tenant
        id: resolve
        run: |
          TENANT="${{ github.event.inputs.tenant }}"
          if [ -z "$TENANT" ]; then
            TENANT=$(git diff --name-only HEAD~1...HEAD | grep '^tenants/' | cut -d'/' -f2 | sort -u | head -1)
          fi
          echo "tenant=$TENANT" >> "$GITHUB_OUTPUT"
          echo "Deploying tenant: $TENANT"

      - name: Validate
        run: lzctl validate --tenant ${{ steps.resolve.outputs.tenant }} --strict --repo-root $LZCTL_REPO_ROOT

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Canary Ring
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  canary:
    name: "ðŸ¤ Canary"
    runs-on: ubuntu-latest
    needs: preflight
    if: contains(fromJSON('["canary","all"]'), github.event.inputs.ring || 'canary')
    environment: canary
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Build lzctl
        run: go build -o ${{ github.workspace }}/bin/lzctl . && echo "${{ github.workspace }}/bin" >> $GITHUB_PATH

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Apply canary
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_USE_OIDC: "true"
        run: |
          LAYER_FLAG=""
          [ -n "${{ github.event.inputs.layer }}" ] && LAYER_FLAG="--layer ${{ github.event.inputs.layer }}"
          lzctl apply --tenant ${{ needs.preflight.outputs.tenant }} --ring canary --auto-approve $LAYER_FLAG --repo-root $LZCTL_REPO_ROOT -vv

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Wave 1 (nonprod)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  wave1:
    name: "ðŸŒŠ Wave 1"
    runs-on: ubuntu-latest
    needs: [preflight, canary]
    if: contains(fromJSON('["wave1","all"]'), github.event.inputs.ring || 'canary')
    environment: wave1
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Build lzctl
        run: go build -o ${{ github.workspace }}/bin/lzctl . && echo "${{ github.workspace }}/bin" >> $GITHUB_PATH

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Apply wave1
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_USE_OIDC: "true"
        run: lzctl apply --tenant ${{ needs.preflight.outputs.tenant }} --ring wave1 --auto-approve --repo-root $LZCTL_REPO_ROOT -vv

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Wave 2 (prod)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  wave2:
    name: "ðŸš€ Wave 2 (PROD)"
    runs-on: ubuntu-latest
    needs: [preflight, wave1]
    if: contains(fromJSON('["wave2","all"]'), github.event.inputs.ring || 'canary')
    environment: wave2
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Build lzctl
        run: go build -o ${{ github.workspace }}/bin/lzctl . && echo "${{ github.workspace }}/bin" >> $GITHUB_PATH

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Apply wave2
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_USE_OIDC: "true"
        run: lzctl apply --tenant ${{ needs.preflight.outputs.tenant }} --ring wave2 --auto-approve --repo-root $LZCTL_REPO_ROOT -vv

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Post-Deploy
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  post-deploy:
    name: "ðŸ“Š Post-Deploy"
    runs-on: ubuntu-latest
    needs: [preflight, canary]
    if: always()
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Build lzctl
        run: go build -o ${{ github.workspace }}/bin/lzctl . && echo "${{ github.workspace }}/bin" >> $GITHUB_PATH

      - name: Post-deploy assessment
        run: lzctl assess --tenant ${{ needs.preflight.outputs.tenant }} --repo-root $LZCTL_REPO_ROOT
        continue-on-error: true

      - name: Regenerate docs
        run: lzctl docs --tenant ${{ needs.preflight.outputs.tenant }} --repo-root $LZCTL_REPO_ROOT

      - name: Commit artifacts
        run: |
          git config user.email "lzctl-bot@github.com"
          git config user.name "lzctl-bot"
          git add tenants/*/docs/ tenants/*/reports/ tenants/*/assess/ 2>/dev/null || true
          git diff --cached --quiet || git commit -m "docs: post-deploy update [skip ci]"
          git push || true
