# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# GitHub Actions â€“ PR Validation
# Landing Zone Factory â€“ GitOps PR Workflow
# Runs: validate â†’ plan â†’ drift assess â†’ docs/diagrams
#
# Mode-aware: lzctl auto-detects accelerator vs manual mode
# from the tenant manifest. In accelerator mode, plan runs
# terraform; in manual mode, plan runs terragrunt.
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

name: "ðŸ”Ž PR Validation"

on:
  pull_request:
    branches: [main, "release/*"]
    paths:
      - "tenants/**"
      - "modules/**"
      - "policies/**"

permissions:
  contents: write
  pull-requests: write
  id-token: write  # OIDC for Azure login

env:
  TF_VERSION: "1.9.0"
  TG_VERSION: "0.67.0"
  GO_VERSION: "1.24"
  LZCTL_REPO_ROOT: ${{ github.workspace }}

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 1: Detect & Validate
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  detect-and-validate:
    name: "ðŸ”Ž Detect & Validate"
    runs-on: ubuntu-latest
    outputs:
      tenants: ${{ steps.detect.outputs.tenants }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed tenants
        id: detect
        run: |
          CHANGED=$(git diff --name-only origin/main...HEAD | grep '^tenants/' | cut -d'/' -f2 | sort -u | jq -R -s -c 'split("\n") | map(select(. != ""))')
          echo "tenants=$CHANGED" >> "$GITHUB_OUTPUT"
          echo "Changed tenants: $CHANGED"

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Build lzctl
        run: go build -o ${{ github.workspace }}/bin/lzctl . && echo "${{ github.workspace }}/bin" >> $GITHUB_PATH

      - name: Validate manifests
        run: lzctl validate --all --strict --repo-root $LZCTL_REPO_ROOT

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 2: Plan (per tenant)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  plan:
    name: "ðŸ“ Plan"
    runs-on: ubuntu-latest
    needs: detect-and-validate
    strategy:
      matrix:
        tenant: ${{ fromJSON(needs.detect-and-validate.outputs.tenants) }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Build lzctl
        run: go build -o ${{ github.workspace }}/bin/lzctl . && echo "${{ github.workspace }}/bin" >> $GITHUB_PATH

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Install Terragrunt
        run: |
          curl -sL "https://github.com/gruntwork-io/terragrunt/releases/download/v${TG_VERSION}/terragrunt_linux_amd64" \
            -o /usr/local/bin/terragrunt && chmod +x /usr/local/bin/terragrunt

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: "lzctl plan â€“ ${{ matrix.tenant }}"
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_USE_OIDC: "true"
        run: lzctl plan --tenant ${{ matrix.tenant }} --repo-root $LZCTL_REPO_ROOT -vv

      - name: Comment PR with plan summary
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const plansDir = `${process.env.LZCTL_REPO_ROOT}/tenants/${{ matrix.tenant }}/plans`;
            let summary = 'No plan output found';
            if (fs.existsSync(plansDir)) {
              const subdirs = fs.readdirSync(plansDir).sort();
              for (const d of subdirs.reverse()) {
                const f = path.join(plansDir, d, 'plan-summary.yaml');
                if (fs.existsSync(f)) { summary = fs.readFileSync(f, 'utf8'); break; }
              }
            }
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ðŸ“ Terragrunt Plan â€“ ${{ matrix.tenant }}\n\n\`\`\`yaml\n${summary}\n\`\`\`\n\n> Generated by \`lzctl plan\``
            });

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 3: Drift Assessment
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  drift:
    name: "ðŸ”„ Drift Assessment"
    runs-on: ubuntu-latest
    needs: detect-and-validate
    strategy:
      matrix:
        tenant: ${{ fromJSON(needs.detect-and-validate.outputs.tenants) }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Build lzctl
        run: go build -o ${{ github.workspace }}/bin/lzctl . && echo "${{ github.workspace }}/bin" >> $GITHUB_PATH

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: "lzctl drift â€“ ${{ matrix.tenant }}"
        run: lzctl drift --tenant ${{ matrix.tenant }} --repo-root $LZCTL_REPO_ROOT
        continue-on-error: true

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 4: Docs & Diagrams
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  docs:
    name: "ðŸ“„ Docs & Diagrams"
    runs-on: ubuntu-latest
    needs: plan
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Build lzctl
        run: go build -o ${{ github.workspace }}/bin/lzctl . && echo "${{ github.workspace }}/bin" >> $GITHUB_PATH

      - name: Generate docs for all changed tenants
        run: |
          TENANTS='${{ needs.detect-and-validate.outputs.tenants }}'
          for tenant in $(echo "$TENANTS" | jq -r '.[]'); do
            lzctl docs --tenant "$tenant" --repo-root $LZCTL_REPO_ROOT
          done

      - name: Commit docs
        run: |
          git config user.email "lzctl-bot@github.com"
          git config user.name "lzctl-bot"
          git add tenants/*/docs/ tenants/*/reports/ 2>/dev/null || true
          git diff --cached --quiet || git commit -m "docs: auto-generate docs and diagrams [skip ci]"
          git diff --cached --quiet 2>/dev/null; git push || true

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 5: Policy Compliance
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  policy-check:
    name: "ðŸ›¡ï¸ Policy Compliance"
    runs-on: ubuntu-latest
    needs: detect-and-validate
    steps:
      - uses: actions/checkout@v4

      - name: Validate policy definitions
        run: |
          echo "Checking policy definition JSON files..."
          find $LZCTL_REPO_ROOT/tenants/*/policies/definitions -name "*.json" 2>/dev/null | while read f; do
            python3 -c "import json; json.load(open('$f'))" || echo "::error file=$f::Invalid JSON"
          done
          echo "Policy validation complete."
