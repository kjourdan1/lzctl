{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://lzctl.io/schemas/lzctl-v1.schema.json",
  "title": "lzctl Landing Zone Configuration",
  "description": "Schema for lzctl.yaml â€” the declarative landing zone configuration file.",
  "type": "object",
  "required": ["apiVersion", "kind", "metadata", "spec"],
  "properties": {
    "apiVersion": {
      "type": "string",
      "enum": ["lzctl/v1"],
      "description": "API version, must be lzctl/v1"
    },
    "kind": {
      "type": "string",
      "enum": ["LandingZone"],
      "description": "Resource kind, must be LandingZone"
    },
    "metadata": {
      "type": "object",
      "required": ["name", "tenant", "primaryRegion"],
      "properties": {
        "name": {
          "type": "string",
          "minLength": 1,
          "description": "Human-readable name for this landing zone"
        },
        "tenant": {
          "type": "string",
          "minLength": 1,
          "description": "Azure AD tenant ID or domain"
        },
        "primaryRegion": {
          "type": "string",
          "minLength": 1,
          "description": "Primary Azure region (e.g. westeurope)"
        },
        "secondaryRegion": {
          "type": "string",
          "description": "Secondary Azure region for DR"
        }
      },
      "additionalProperties": false
    },
    "spec": {
      "type": "object",
      "required": ["platform", "governance", "naming", "stateBackend", "cicd"],
      "properties": {
        "platform": {
          "$ref": "#/definitions/Platform"
        },
        "governance": {
          "$ref": "#/definitions/Governance"
        },
        "naming": {
          "$ref": "#/definitions/Naming"
        },
        "stateBackend": {
          "$ref": "#/definitions/StateBackend"
        },
        "landingZones": {
          "type": ["array", "null"],
          "items": {
            "$ref": "#/definitions/LandingZone"
          },
          "description": "List of subscription-level landing zones"
        },
        "cicd": {
          "$ref": "#/definitions/CICD"
        }
      },
      "additionalProperties": false
    }
  },
  "additionalProperties": false,

  "definitions": {
    "Platform": {
      "type": "object",
      "required": ["managementGroups", "connectivity", "identity", "management"],
      "properties": {
        "managementGroups": {
          "type": "object",
          "required": ["model"],
          "properties": {
            "model": {
              "type": "string",
              "enum": ["caf-standard", "caf-lite"]
            },
            "disabled": {
              "type": "array",
              "items": { "type": "string" }
            }
          },
          "additionalProperties": false
        },
        "connectivity": {
          "type": "object",
          "required": ["type"],
          "properties": {
            "type": {
              "type": "string",
              "enum": ["hub-spoke", "vwan", "none"]
            },
            "hub": {
              "$ref": "#/definitions/HubConfig"
            }
          },
          "additionalProperties": false
        },
        "identity": {
          "type": "object",
          "required": ["type"],
          "properties": {
            "type": {
              "type": "string",
              "enum": ["workload-identity-federation", "sp-federated", "sp-secret"]
            },
            "clientId": { "type": "string" },
            "principalId": { "type": "string" }
          },
          "additionalProperties": false
        },
        "management": {
          "type": "object",
          "required": ["logAnalytics", "defenderForCloud"],
          "properties": {
            "logAnalytics": {
              "type": "object",
              "required": ["retentionDays"],
              "properties": {
                "retentionDays": {
                  "type": "integer",
                  "minimum": 30,
                  "maximum": 730
                },
                "solutions": {
                  "type": "array",
                  "items": { "type": "string" }
                }
              },
              "additionalProperties": false
            },
            "automationAccount": { "type": "boolean" },
            "defenderForCloud": {
              "type": "object",
              "required": ["enabled"],
              "properties": {
                "enabled": { "type": "boolean" },
                "plans": {
                  "type": "array",
                  "items": { "type": "string" }
                }
              },
              "additionalProperties": false
            }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    },

    "HubConfig": {
      "type": "object",
      "required": ["region", "addressSpace"],
      "properties": {
        "region": { "type": "string", "minLength": 1 },
        "addressSpace": {
          "type": "string",
          "pattern": "^\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}/\\d{1,2}$"
        },
        "firewall": {
          "type": "object",
          "properties": {
            "enabled": { "type": "boolean" },
            "sku": {
              "type": "string",
              "enum": ["Standard", "Premium"]
            },
            "threatIntel": {
              "type": "string",
              "enum": ["Alert", "Deny", "Off"]
            }
          },
          "additionalProperties": false
        },
        "dns": {
          "type": "object",
          "properties": {
            "privateResolver": { "type": "boolean" },
            "forwarders": {
              "type": "array",
              "items": { "type": "string" }
            }
          },
          "additionalProperties": false
        },
        "vpnGateway": {
          "$ref": "#/definitions/GatewayConfig"
        },
        "expressRouteGateway": {
          "$ref": "#/definitions/GatewayConfig"
        }
      },
      "additionalProperties": false
    },

    "GatewayConfig": {
      "type": "object",
      "properties": {
        "enabled": { "type": "boolean" },
        "sku": { "type": "string" }
      },
      "additionalProperties": false
    },

    "Governance": {
      "type": "object",
      "required": ["policies"],
      "properties": {
        "policies": {
          "type": "object",
          "required": ["assignments"],
          "properties": {
            "assignments": {
              "type": "array",
              "items": { "type": "string" },
              "minItems": 1
            },
            "custom": {
              "type": "array",
              "items": { "type": "string" }
            }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    },

    "Naming": {
      "type": "object",
      "required": ["convention"],
      "properties": {
        "convention": {
          "type": "string",
          "enum": ["caf"]
        },
        "overrides": {
          "type": "object",
          "additionalProperties": { "type": "string" }
        }
      },
      "additionalProperties": false
    },

    "StateBackend": {
      "type": "object",
      "required": ["resourceGroup", "storageAccount", "container", "subscription"],
      "properties": {
        "resourceGroup": { "type": "string", "minLength": 1, "description": "Resource group containing the state storage account" },
        "storageAccount": { "type": "string", "minLength": 1, "description": "Azure Storage account name for Terraform state" },
        "container": { "type": "string", "minLength": 1, "description": "Blob container name (default: tfstate)" },
        "subscription": { "type": "string", "minLength": 1, "description": "Subscription ID hosting the state backend" },
        "versioning": { "type": "boolean", "default": true, "description": "Enable blob versioning for state history and rollback" },
        "softDelete": { "type": "boolean", "default": true, "description": "Enable soft delete for accidental deletion protection" },
        "softDeleteDays": { "type": "integer", "minimum": 1, "maximum": 365, "default": 30, "description": "Retention days for soft-deleted state blobs" }
      },
      "additionalProperties": false
    },

    "LandingZone": {
      "type": "object",
      "required": ["name", "subscription", "archetype", "addressSpace", "connected"],
      "properties": {
        "name": { "type": "string", "minLength": 1 },
        "subscription": { "type": "string", "minLength": 1 },
        "archetype": {
          "type": "string",
          "enum": ["corp", "online", "sandbox"]
        },
        "addressSpace": {
          "type": "string",
          "pattern": "^\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}/\\d{1,2}$"
        },
        "connected": { "type": "boolean" },
        "tags": {
          "type": "object",
          "additionalProperties": { "type": "string" }
        }
      },
      "additionalProperties": false
    },

    "CICD": {
      "type": "object",
      "required": ["platform", "branchPolicy"],
      "properties": {
        "platform": {
          "type": "string",
          "enum": ["github-actions", "azure-devops"]
        },
        "repository": { "type": "string" },
        "branchPolicy": {
          "type": "object",
          "properties": {
            "mainBranch": { "type": "string" },
            "requirePR": { "type": "boolean" }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    }
  }
}
