# Generated by lzctl â€” Atlantis pull-mode configuration
# One PR = one layer. Atlantis handles plan/apply; CI handles lint/validate only.
version: 3
automerge: false
delete_source_branch_on_merge: false
parallel_plan: false
parallel_apply: false

projects:
  # --- Platform layers (CAF dependency order) ---
{{- range $i, $layer := .Layers }}
  - name: {{ $layer }}
    dir: platform/{{ $layer }}
    workspace: default
    terraform_version: "~> 1.5"
    autoplan:
      when_modified: ["*.tf", "*.tfvars", "../../platform/shared/backend.hcl"]
      enabled: true
    apply_requirements:
      - approved
      - mergeable
{{- if gt $i 0 }}
    depends_on:
      - {{ index $.Layers (sub $i 1) }}
{{- end }}
    workflow: platform-layer
{{- end }}

  # --- Landing zones ---
{{- range .Config.Spec.LandingZones }}
  - name: lz-{{ .Name | slugify }}
    dir: landing-zones/{{ .Name | slugify }}
    workspace: default
    terraform_version: "~> 1.5"
    autoplan:
      when_modified: ["*.tf", "*.tfvars"]
      enabled: true
    apply_requirements:
      - approved
      - mergeable
    depends_on:
      - connectivity
    workflow: landing-zone-layer
{{- if .Blueprint }}

  - name: lz-{{ .Name | slugify }}-blueprint
    dir: landing-zones/{{ .Name | slugify }}/blueprint
    workspace: default
    terraform_version: "~> 1.5"
    autoplan:
      when_modified: ["*.tf", "*.tfvars"]
      enabled: true
    apply_requirements:
      - approved
      - mergeable
    depends_on:
      - lz-{{ .Name | slugify }}
    workflow: landing-zone-layer
{{- end }}
{{- end }}

workflows:
  platform-layer:
    plan:
      steps:
        - init:
            extra_args: ["-input=false", "-backend-config=../../platform/shared/backend.hcl", "-no-color"]
        - plan:
            extra_args: ["-input=false", "-no-color"]
    apply:
      steps:
        - apply:
            extra_args: ["-input=false", "-no-color"]
  landing-zone-layer:
    plan:
      steps:
        - init:
            extra_args: ["-input=false", "-backend-config=../../platform/shared/backend.hcl", "-no-color"]
        - plan:
            extra_args: ["-input=false", "-no-color"]
    apply:
      steps:
        - apply:
            extra_args: ["-input=false", "-no-color"]
