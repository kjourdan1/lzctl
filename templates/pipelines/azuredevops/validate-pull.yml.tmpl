# Generated by lzctl â€” CI validation pipeline (pull/GitOps mode)
# In pull mode, Atlantis handles plan/apply. This pipeline only validates.
trigger: none
pr:
  branches:
    include:
      - {{ .Config.Spec.CICD.BranchPolicy.MainBranch }}

pool:
  vmImage: ubuntu-latest

steps:
  - checkout: self

  - task: TerraformInstaller@1
    inputs:
      terraformVersion: 'latest'

  # --- Terraform fmt check ---
  - script: |
      set -euo pipefail
      for d in platform/*/; do
        [ -d "$d" ] || continue
        echo "Checking format: $d"
        terraform fmt -check -recursive "$d" || { echo "##vso[task.logissue type=error]terraform fmt check failed in $d"; exit 1; }
      done
    displayName: Terraform fmt check

  # --- Terraform validate (no backend) ---
  - script: |
      set -euo pipefail
      for d in platform/*/; do
        [ -d "$d" ] || continue
        echo "Validating: $d"
        terraform -chdir="$d" init -backend=false -input=false -no-color
        terraform -chdir="$d" validate
      done
    displayName: Terraform validate platform layers

  # --- Policy scan (Checkov) ---
  - script: pip install checkov && checkov -d platform/ --quiet
    displayName: Checkov policy scan
    continueOnError: false
