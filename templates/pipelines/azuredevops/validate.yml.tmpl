trigger: none
pr:
  branches:
    include:
      - {{ .Config.Spec.CICD.BranchPolicy.MainBranch }}

pool:
  vmImage: ubuntu-latest

steps:
  - checkout: self
  - task: TerraformInstaller@1
    inputs:
      terraformVersion: 'latest'
  - script: |
      set -euo pipefail
      for d in platform/management-groups platform/identity platform/management platform/governance platform/connectivity; do
        if [ -d "$d" ]; then
          terraform -chdir="$d" init -backend=false -input=false
          terraform -chdir="$d" validate
        fi
      done
    displayName: Terraform validate platform layers
{{ if .Config.Spec.LandingZones }}
  # Landing zones + blueprints
  - script: |
      set -euo pipefail
      for d in {{ range .Config.Spec.LandingZones }}landing-zones/{{ .Name | slugify }} {{ if .Blueprint }}landing-zones/{{ .Name | slugify }}/blueprint {{ end }}{{ end }}; do
        if [ -d "$d" ]; then
          terraform -chdir="$d" init -backend=false -input=false
          terraform -chdir="$d" validate
        fi
      done
    displayName: Terraform validate landing zones and blueprints
{{ end }}
