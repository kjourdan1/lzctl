name: Deploy

on:
  push:
    branches: ["{{ .Config.Spec.CICD.BranchPolicy.MainBranch }}"]

jobs:
  plan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3

      # ── Plan layers and generate JSON for destroy gate ────────────
      - name: Plan platform layers
        run: |
          set -euo pipefail
          for d in platform/management-groups platform/identity platform/management platform/governance platform/connectivity; do
            [ -d "$d" ] || continue
            echo "═══ Planning: $d ═══"
            terraform -chdir="$d" init -input=false -backend-config=../../backend.hcl -no-color
            terraform -chdir="$d" plan -out=tfplan -input=false -no-color || true
            terraform -chdir="$d" show -json tfplan > "$d/tfplan.json" 2>/dev/null || true
          done

      # ── Gate on destructive actions ───────────────────────────────
      - name: Gate on destructive actions
        run: |
          set -euo pipefail
          DESTROY=0
          for f in platform/*/tfplan.json; do
            [ -f "$f" ] || continue
            N=$(jq '[.resource_changes[]? |
              select(
                (.change.actions | contains(["delete"])) and
                (.type | IN("null_resource","azurerm_resource_group_template_deployment") | not) and
                (.type | startswith("random_") | not)
              )] | length' "$f" 2>/dev/null || echo 0)
            if [ "$N" -gt 0 ]; then
              echo "::error file=$f::$N destructive action(s) detected. Review plan before applying."
              DESTROY=$((DESTROY + N))
            fi
          done
          [ "$DESTROY" -eq 0 ] || exit 1

      - uses: actions/upload-artifact@v4
        with:
          name: tfplans
          path: platform/*/tfplan
          if-no-files-found: ignore

  apply:
    needs: plan
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3
      - uses: actions/download-artifact@v4
        with:
          name: tfplans
          path: platform

      # ── State Life Management: snapshot before apply ──────────────
      # Creates a point-in-time backup of all state files before mutation.
      # Azure blob versioning preserves state history for rollback.
      - name: Snapshot state before apply
        run: |
          set -euo pipefail
          echo "Creating pre-apply state snapshots..."
          for key in $(az storage blob list \
            --account-name "{{ .Config.Spec.StateBackend.StorageAccount }}" \
            --container "{{ .Config.Spec.StateBackend.Container }}" \
            --auth-mode login \
            --query "[?ends_with(name,'.tfstate')].name" -o tsv); do
            az storage blob snapshot \
              --account-name "{{ .Config.Spec.StateBackend.StorageAccount }}" \
              --container "{{ .Config.Spec.StateBackend.Container }}" \
              --name "$key" \
              --auth-mode login \
              --output none && echo "  ✓ snapshot: $key"
          done

      # ── Apply layers in dependency order ─────────────────────────
      - name: Apply platform layers
        run: |
          set -euo pipefail
          for d in platform/management-groups platform/identity platform/management platform/governance platform/connectivity; do
            [ -d "$d" ] || continue
            echo "═══ Applying: $d ═══"
            terraform -chdir="$d" init -input=false -backend-config=../../backend.hcl -no-color
            if [ -f "$d/tfplan" ]; then
              terraform -chdir="$d" apply -input=false -no-color tfplan
            else
              terraform -chdir="$d" apply -auto-approve -input=false -no-color
            fi
          done{{ if .Config.Spec.LandingZones }}
      # ── Apply landing zones + blueprints (LZ → blueprint order) ──────
      - name: Apply landing zones and blueprints
        run: |
          set -euo pipefail
          for d in {{ range .Config.Spec.LandingZones }}landing-zones/{{ .Name | slugify }} {{ if .Blueprint }}landing-zones/{{ .Name | slugify }}/blueprint {{ end }}{{ end }}; do
            if [ -d "$d" ]; then
              echo "═══ Applying: $d ═══"
              [[ "$d" == */blueprint ]] && BCFG="-backend-config=backend.hcl" || BCFG="-backend-config=../../backend.hcl"
              terraform -chdir="$d" init -input=false $BCFG -no-color
              terraform -chdir="$d" apply -auto-approve -input=false -no-color
            fi
          done
{{ end }}
