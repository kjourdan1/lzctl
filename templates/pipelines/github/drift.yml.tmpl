name: Drift Detection

on:
  schedule:
    - cron: "0 2 * * 0"
  workflow_dispatch:

jobs:
  terraform-drift:
    runs-on: ubuntu-latest
    outputs:
      drift_detected: ${{"{{"}} steps.drift.outputs.drift_detected {{"}}"}}
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3
      - name: Detect drift
        id: drift
        run: |
          set -euo pipefail
          DRIFT=0
          for d in platform/management-groups platform/identity platform/management platform/governance platform/connectivity{{ range .Config.Spec.LandingZones }} landing-zones/{{ .Name | slugify }}{{ if .Blueprint }} landing-zones/{{ .Name | slugify }}/blueprint{{ end }}{{ end }}; do
            if [ -d "$d" ]; then
              terraform -chdir="$d" init -input=false
              terraform -chdir="$d" plan -detailed-exitcode -input=false -out=tfplan 2>&1 || code=$?
              if [ "${code:-0}" -eq 2 ]; then
                echo "::warning::Drift detected in $d"
                DRIFT=1
              elif [ "${code:-0}" -eq 1 ]; then
                echo "::error::Terraform error in $d"
                exit 1
              fi
            fi
          done
          echo "drift_detected=$DRIFT" >> "$GITHUB_OUTPUT"

  create-issue:
    needs: terraform-drift
    if: needs.terraform-drift.outputs.drift_detected == '1'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Create drift issue
        env:
          GH_TOKEN: ${{"{{"}} secrets.GITHUB_TOKEN {{"}}"}}
        run: |
          gh issue create \
            --title "ðŸ”€ Infrastructure drift detected ($(date +%Y-%m-%d))" \
            --body "Automated drift detection found configuration differences between Terraform state and live Azure resources.\n\nRun \`lzctl drift --tenant {{ .Config.Metadata.Tenant }}\` locally for details.\n\nTriggered by: ${{"{{"}} github.server_url {{"}}"}}/${{"{{"}} github.repository {{"}}"}}/actions/runs/${{"{{"}} github.run_id {{"}}"}}" \
            --label "drift-detected,infrastructure" \
            --assignee "${{"{{"}} github.repository_owner {{"}}"}}"
