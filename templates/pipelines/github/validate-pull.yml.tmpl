# Generated by lzctl â€” CI validation pipeline (pull/GitOps mode)
# In pull mode, Atlantis handles plan/apply. This pipeline only validates.
name: Validate

on:
  pull_request:
    branches: ["{{ .Config.Spec.CICD.BranchPolicy.MainBranch }}"]
  push:
    branches: ["{{ .Config.Spec.CICD.BranchPolicy.MainBranch }}"]

jobs:
  validate:
    name: Lint, Format & Validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3

      # --- Terraform fmt check ---
      - name: Terraform fmt check
        run: |
          set -euo pipefail
          for d in platform/*/; do
            [ -d "$d" ] || continue
            echo "Checking format: $d"
            terraform fmt -check -recursive "$d" || { echo "::error::terraform fmt check failed in $d"; exit 1; }
          done

      # --- Terraform validate (no backend) ---
      - name: Terraform validate
        run: |
          set -euo pipefail
          for d in platform/*/; do
            [ -d "$d" ] || continue
            echo "Validating: $d"
            terraform -chdir="$d" init -backend=false -input=false -no-color
            terraform -chdir="$d" validate
          done

      # --- Policy scan (Checkov) ---
      - name: Checkov policy scan
        uses: bridgecrewio/checkov-action@master
        with:
          directory: platform/
          quiet: true
          soft_fail: false
