name: Validate

on:
  pull_request:
    branches: ["{{ .Config.Spec.CICD.BranchPolicy.MainBranch }}"]

jobs:
  terraform-validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3
      - name: Validate platform layers
        run: |
          set -euo pipefail
          for d in platform/management-groups platform/identity platform/management platform/governance platform/connectivity; do
            if [ -d "$d" ]; then
              terraform -chdir="$d" init -backend=false -input=false
              terraform -chdir="$d" validate
            fi
          done
{{ if .Config.Spec.LandingZones }}
      # ── Validate landing zones + blueprints ─────────────────────────
      - name: Validate landing zones and blueprints
        run: |
          set -euo pipefail
          for d in {{ range .Config.Spec.LandingZones }}landing-zones/{{ .Name | slugify }} {{ if .Blueprint }}landing-zones/{{ .Name | slugify }}/blueprint {{ end }}{{ end }}; do
            if [ -d "$d" ]; then
              terraform -chdir="$d" init -backend=false -input=false
              terraform -chdir="$d" validate
            fi
          done
{{ end }}
